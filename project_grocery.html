<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Analyzer | Ryan Stefan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for React & Lucide -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?external=react"
      }
    }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { brand: { 500: '#0ea5e9', 600: '#0284c7' } } }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 antialiased min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="fixed w-full bg-white/90 backdrop-blur-sm shadow-sm z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center">
            <a href="projects.html" class="text-brand-600 font-bold hover:text-brand-500 transition flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Projects
            </a>
            <span class="ml-auto text-sm text-slate-500 hidden sm:block">AI-Powered Receipt Analysis</span>
        </div>
    </nav>

    <!-- App Container -->
    <main id="root" class="flex-grow pt-16"></main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-300 py-8 border-t border-slate-800">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p>&copy; 2025 Ryan Stefan. All rights reserved.</p>
        </div>
    </footer>

    <!-- React App Logic -->
    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useRef, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Upload, X, Plus, Loader2, PieChart, DollarSign, ShoppingBag, ChevronDown, ChevronUp, Trash2, Camera, AlertCircle, Lightbulb, Sparkles, Settings, Key } from 'lucide-react';

        // --- API & Helper Functions ---

        // Mock data for demo mode
        const MOCK_RECEIPT = {
            storeName: "Demo Market",
            date: new Date().toISOString().split('T')[0],
            items: [
                { name: "Organic Bananas", quantity: 1, unitPrice: 1.29, totalPrice: 1.29, category: "Fruits" },
                { name: "Almond Milk", quantity: 1, unitPrice: 3.49, totalPrice: 3.49, category: "Dairy" },
                { name: "Whole Wheat Bread", quantity: 1, unitPrice: 4.50, totalPrice: 4.50, category: "Bakery" },
                { name: "Chicken Breast", quantity: 2, unitPrice: 5.50, totalPrice: 11.00, category: "Meat" },
                { name: "Spinach", quantity: 1, unitPrice: 2.99, totalPrice: 2.99, category: "Vegetables" }
            ],
            totalAmount: 23.27
        };

        const MOCK_TIPS = "1. Switch to store-brand almond milk to save ~$0.50.\n2. Buy chicken in bulk family packs to reduce price per pound.\n3. Freeze extra spinach to prevent spoilage waste.";

        const analyzeReceiptImage = async (base64Image, mimeType, apiKey) => {
          if (!apiKey) {
              console.log("No API Key provided, using Demo Mode.");
              await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay
              return { ...MOCK_RECEIPT, id: Date.now(), isMock: true };
          }

          const prompt = `
            Analyze this grocery receipt image. 
            Extract the following for every line item:
            - Item Name (concise)
            - Quantity (number, default to 1 if not specified)
            - Unit Price (number, infer from total if necessary)
            - Total Price (number)
            - Category (Strictly one of: "Dairy", "Vegetables", "Fruits", "Meat", "Pantry", "Bakery", "Beverages", "Household", "Personal Care", "Other")

            Return a purely JSON object with this structure:
            {
              "storeName": "Name of Store",
              "date": "YYYY-MM-DD", 
              "items": [
                { "name": "Milk", "quantity": 1, "unitPrice": 3.50, "totalPrice": 3.50, "category": "Dairy" }
              ],
              "totalAmount": 0.00
            }
            Ensure numeric values are numbers, not strings.
          `;

          try {
            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  contents: [{
                    role: "user",
                    parts: [
                      { text: prompt },
                      { inlineData: { mimeType: mimeType, data: base64Image } }
                    ]
                  }],
                  generationConfig: {
                    responseMimeType: "application/json"
                  }
                })
              }
            );

            if (!response.ok) {
              const errData = await response.json();
              throw new Error(errData.error?.message || `API Error: ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) throw new Error("No data returned");

            return JSON.parse(text);
          } catch (error) {
            console.error("Analysis failed", error);
            throw error;
          }
        };

        const getSavingsTips = async (receipts, apiKey) => {
          if (!apiKey) {
             await new Promise(resolve => setTimeout(resolve, 1000));
             return MOCK_TIPS;
          }

          // summarize data to save tokens and focus the AI
          const summaryText = receipts.map(r => 
            `Store: ${r.storeName}, Total: $${r.totalAmount.toFixed(2)}, Items: ${r.items.map(i => `${i.name} ($${i.totalPrice.toFixed(2)})`).join(', ')}`
          ).join('\n---\n');

          const prompt = `
            You are a frugal financial advisor specializing in grocery inflation. 
            Analyze these receipt summaries:
            ${summaryText}

            Provide 3 specific, actionable, and short tips to help this shopper save money next time. 
            Focus on specific items they bought (e.g., "Switching from brand-name cereal to generic could save $X").
            Do not give generic advice like "use coupons" unless it applies to a specific item bought.
            Strictly format the output as a numbered list (e.g., 1. Tip one..., 2. Tip two...).
          `;

          try {
            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  contents: [{ parts: [{ text: prompt }] }]
                })
              }
            );

            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || "No tips generated.";
          } catch (error) {
            console.error("Tips generation failed", error);
            throw new Error("Could not generate tips at this time.");
          }
        };

        // --- Components ---

        // Custom SVG Pie Chart to avoid external dependencies
        const SimplePieChart = ({ data }) => {
          const total = data.reduce((acc, item) => acc + item.value, 0);
          let currentAngle = 0;

          if (total === 0) return (
            <div className="flex items-center justify-center h-64 text-gray-400 bg-gray-50 rounded-full aspect-square mx-auto">
              No Data
            </div>
          );

          const colors = [
            "#3B82F6", "#10B981", "#F59E0B", "#EF4444", "#8B5CF6", 
            "#EC4899", "#6366F1", "#14B8A6", "#F97316", "#64748B"
          ];

          return (
            <div className="flex flex-col items-center w-full">
              <div className="relative h-64 w-64">
                <svg viewBox="-1 -1 2 2" className="transform -rotate-90 w-full h-full">
                  {data.map((slice, index) => {
                    const sliceAngle = (slice.value / total) * 2 * Math.PI;
                    const x1 = Math.cos(currentAngle);
                    const y1 = Math.sin(currentAngle);
                    const x2 = Math.cos(currentAngle + sliceAngle);
                    const y2 = Math.sin(currentAngle + sliceAngle);
                    
                    const largeArcFlag = sliceAngle > Math.PI ? 1 : 0;
                    
                    const pathData = `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                    
                    currentAngle += sliceAngle;
                    
                    return (
                      <path
                        key={slice.name}
                        d={pathData}
                        fill={colors[index % colors.length]}
                        stroke="white"
                        strokeWidth="0.02"
                      />
                    );
                  })}
                </svg>
              </div>
              {/* Legend */}
              <div className="mt-8 grid grid-cols-2 gap-3 text-xs w-full border-t border-slate-100 pt-6">
                {data.map((item, index) => (
                  <div key={item.name} className="flex items-center gap-2">
                    <span 
                      className="w-3 h-3 rounded-full shrink-0" 
                      style={{ backgroundColor: colors[index % colors.length] }}
                    />
                    <span className="truncate flex-1 text-slate-600">{item.name}</span>
                    <span className="font-semibold text-slate-800">${item.value.toFixed(2)}</span>
                  </div>
                ))}
              </div>
            </div>
          );
        };

        const ReceiptCard = ({ receipt, onDelete }) => {
          const [expanded, setExpanded] = useState(false);

          return (
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4 transition-all hover:shadow-md">
              <div 
                className="p-4 flex items-center justify-between cursor-pointer bg-slate-50 hover:bg-slate-100"
                onClick={() => setExpanded(!expanded)}
              >
                <div className="flex items-center gap-3">
                  <div className="bg-blue-100 p-2 rounded-lg text-blue-600">
                    <ShoppingBag size={20} />
                  </div>
                  <div>
                    <h3 className="font-semibold text-slate-800 flex items-center gap-2">
                        {receipt.storeName || "Unknown Store"}
                        {receipt.isMock && <span className="bg-yellow-100 text-yellow-800 text-[10px] px-1.5 py-0.5 rounded-full uppercase tracking-wide font-bold">Demo</span>}
                    </h3>
                    <p className="text-xs text-slate-500">{receipt.date || "No Date"} â€¢ {receipt.items.length} items</p>
                  </div>
                </div>
                <div className="flex items-center gap-4">
                  <span className="font-bold text-lg text-slate-700">${receipt.totalAmount.toFixed(2)}</span>
                  {expanded ? <ChevronUp size={20} className="text-slate-400" /> : <ChevronDown size={20} className="text-slate-400" />}
                </div>
              </div>
              
              {expanded && (
                <div className="p-4 border-t border-slate-200">
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left">
                      <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                        <tr>
                          <th className="px-2 py-2">Item</th>
                          <th className="px-2 py-2">Category</th>
                          <th className="px-2 py-2 text-right">Qty</th>
                          <th className="px-2 py-2 text-right">Amount</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-slate-100">
                        {receipt.items.map((item, idx) => (
                          <tr key={idx} className="hover:bg-slate-50">
                            <td className="px-2 py-2 font-medium text-slate-700">{item.name}</td>
                            <td className="px-2 py-2">
                              <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                {item.category}
                              </span>
                            </td>
                            <td className="px-2 py-2 text-right text-slate-500">{item.quantity}</td>
                            <td className="px-2 py-2 text-right font-medium">${item.totalPrice.toFixed(2)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <div className="mt-4 flex justify-end">
                    <button 
                      onClick={(e) => { e.stopPropagation(); onDelete(receipt.id); }}
                      className="flex items-center gap-2 text-red-600 hover:text-red-700 text-sm font-medium px-3 py-2 rounded-lg hover:bg-red-50 transition-colors"
                    >
                      <Trash2 size={16} />
                      Delete Receipt
                    </button>
                  </div>
                </div>
              )}
            </div>
          );
        };

        function App() {
          const [receipts, setReceipts] = useState([]);
          const [isProcessing, setIsProcessing] = useState(false);
          const [isGeneratingTips, setIsGeneratingTips] = useState(false);
          const [tips, setTips] = useState(null);
          const [error, setError] = useState(null);
          const [userApiKey, setUserApiKey] = useState("");
          const [showSettings, setShowSettings] = useState(false);
          const fileInputRef = useRef(null);

          // Derived State for Charts and Summaries
          const summary = useMemo(() => {
            let totalSpent = 0;
            const categoryTotals = {};

            receipts.forEach(r => {
              totalSpent += r.totalAmount;
              r.items.forEach(item => {
                const cat = item.category || "Other";
                categoryTotals[cat] = (categoryTotals[cat] || 0) + item.totalPrice;
              });
            });

            const chartData = Object.entries(categoryTotals)
              .map(([name, value]) => ({ name, value }))
              .sort((a, b) => b.value - a.value);

            return { totalSpent, chartData };
          }, [receipts]);

          const handleFileUpload = async (event) => {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            setTips(null); // Reset tips when new data is added

            if (receipts.length + files.length > 5) {
              setError("Maximum 5 receipts allowed.");
              return;
            }

            setIsProcessing(true);
            setError(null);

            try {
              const promises = files.map(async (file) => {
                return new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onloadend = async () => {
                    try {
                      const base64String = reader.result.split(',')[1];
                      const mimeType = file.type;
                      // Pass the user API Key here
                      const data = await analyzeReceiptImage(base64String, mimeType, userApiKey);
                      resolve({ ...data, id: Date.now() + Math.random(), originalImage: reader.result });
                    } catch (err) {
                      reject(err);
                    }
                  };
                  reader.onerror = reject;
                  reader.readAsDataURL(file);
                });
              });

              const results = await Promise.all(promises);
              setReceipts(prev => [...prev, ...results]);
              
              if (!userApiKey) {
                  setError("Running in Demo Mode (Mock Data). Enter a Gemini API Key in settings for real analysis.");
              }

            } catch (err) {
              setError(`Processing failed: ${err.message}. Please try again.`);
              console.error(err);
            } finally {
              setIsProcessing(false);
              if (fileInputRef.current) fileInputRef.current.value = "";
            }
          };

          const handleGenerateTips = async () => {
            setIsGeneratingTips(true);
            try {
              const advice = await getSavingsTips(receipts, userApiKey);
              setTips(advice);
            } catch (err) {
              setError("Could not generate tips. Please try again.");
            } finally {
              setIsGeneratingTips(false);
            }
          };

          const handleDeleteReceipt = (id) => {
            setReceipts(prev => prev.filter(r => r.id !== id));
            setTips(null); 
          };

          return (
            <div className="bg-slate-50 font-sans text-slate-900 pb-20 pt-6">
              <div className="max-w-md mx-auto px-4 py-4 flex items-center justify-between bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                <div className="flex items-center gap-2">
                  <div className="bg-green-600 text-white p-2 rounded-lg">
                    <DollarSign size={20} />
                  </div>
                  <h1 className="text-xl font-bold text-slate-800 tracking-tight">Grocery Analyzer</h1>
                </div>
                <div className="flex items-center gap-3">
                    <div className="text-xs font-medium text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                    {receipts.length}/5
                    </div>
                    <button 
                        onClick={() => setShowSettings(!showSettings)}
                        className="text-slate-400 hover:text-slate-600 transition"
                        title="Settings"
                    >
                        <Settings size={20} />
                    </button>
                </div>
              </div>

              <div className="max-w-md mx-auto px-4 space-y-6">

                {/* Settings Panel */}
                {showSettings && (
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 animate-in slide-in-from-top-2">
                        <h3 className="text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                            <Key size={16} /> API Configuration
                        </h3>
                        <input 
                            type="password"
                            placeholder="Enter Gemini API Key (Optional)"
                            value={userApiKey}
                            onChange={(e) => setUserApiKey(e.target.value)}
                            className="w-full text-sm border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-500 outline-none"
                        />
                        <p className="text-xs text-slate-400 mt-2">
                            Leave empty to use <strong>Demo Mode</strong> with mock data.
                        </p>
                    </div>
                )}
                
                {error && (
                  <div className="bg-yellow-50 text-yellow-800 p-4 rounded-xl flex items-start gap-3 text-sm animate-in fade-in slide-in-from-top-2 border border-yellow-100">
                    <AlertCircle size={18} className="shrink-0 mt-0.5" />
                    <p>{error}</p>
                    <button onClick={() => setError(null)} className="ml-auto hover:text-yellow-900"><X size={16}/></button>
                  </div>
                )}

                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <p className="text-xs text-slate-500 font-medium uppercase tracking-wider mb-1">Total Spent</p>
                    <p className="text-2xl font-bold text-slate-800">${summary.totalSpent.toFixed(2)}</p>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <p className="text-xs text-slate-500 font-medium uppercase tracking-wider mb-1">Items Tracked</p>
                    <p className="text-2xl font-bold text-slate-800">
                      {receipts.reduce((acc, r) => acc + r.items.length, 0)}
                    </p>
                  </div>
                </div>

                {summary.totalSpent > 0 && (
                  <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 className="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                      <PieChart size={20} className="text-slate-400" />
                      Spending Breakdown
                    </h2>
                    <SimplePieChart data={summary.chartData} />
                  </div>
                )}

                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                     <h2 className="text-lg font-bold text-slate-800">Transactions</h2>
                     {receipts.length < 5 && (
                       <button 
                        onClick={() => fileInputRef.current?.click()}
                        disabled={isProcessing}
                        className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                       >
                         {isProcessing ? <Loader2 size={16} className="animate-spin" /> : <Plus size={16} />}
                         Add Receipt
                       </button>
                     )}
                  </div>
                  
                  <input 
                    type="file" 
                    ref={fileInputRef}
                    className="hidden" 
                    accept="image/*" 
                    multiple
                    onChange={handleFileUpload}
                  />

                  {receipts.length === 0 && !isProcessing && (
                    <div 
                      onClick={() => fileInputRef.current?.click()}
                      className="border-2 border-dashed border-slate-300 rounded-xl p-8 flex flex-col items-center justify-center text-center cursor-pointer hover:border-green-500 hover:bg-green-50 transition-all group"
                    >
                      <div className="bg-slate-100 p-4 rounded-full mb-4 group-hover:bg-green-100 transition-colors">
                        <Camera size={32} className="text-slate-400 group-hover:text-green-600" />
                      </div>
                      <h3 className="text-slate-900 font-medium mb-1">Snap a photo</h3>
                      <p className="text-slate-500 text-sm">Upload a grocery receipt to see it in action.</p>
                      <p className="text-xs text-brand-500 mt-2 font-medium">(Try it now - Mock Data enabled!)</p>
                    </div>
                  )}

                  {isProcessing && (
                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center text-center animate-pulse">
                      <Loader2 size={32} className="text-green-600 animate-spin mb-3" />
                      <p className="font-medium text-slate-800">Analyzing Receipt...</p>
                      <p className="text-xs text-slate-500 mt-1">Extracting items, prices, and categories.</p>
                      {!userApiKey && <p className="text-xs text-yellow-600 mt-2 font-medium">Generating Mock Data...</p>}
                    </div>
                  )}

                  <div className="space-y-4">
                    {receipts.map(receipt => (
                      <ReceiptCard 
                        key={receipt.id} 
                        receipt={receipt} 
                        onDelete={handleDeleteReceipt} 
                      />
                    ))}
                  </div>
                </div>

                {receipts.length > 0 && (
                  <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-6 border border-indigo-100 shadow-sm">
                    <div className="flex items-center gap-2 mb-4">
                      <Sparkles className="text-indigo-600" size={20} />
                      <h2 className="text-lg font-bold text-indigo-900">Smart Savings Advisor</h2>
                    </div>
                    
                    {!tips ? (
                      <div className="text-center py-6">
                        <p className="text-sm text-indigo-700 mb-4">
                          Get personalized inflation-fighting tips based on your actual purchases.
                        </p>
                        <button 
                          onClick={handleGenerateTips}
                          disabled={isGeneratingTips}
                          className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 mx-auto transition-all shadow-sm hover:shadow active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {isGeneratingTips ? <Loader2 size={16} className="animate-spin" /> : <Lightbulb size={16} />}
                          Analyze & Get Tips
                        </button>
                      </div>
                    ) : (
                      <div className="animate-in fade-in slide-in-from-bottom-2">
                         <div className="prose prose-sm text-slate-700 prose-indigo max-w-none">
                           <div className="whitespace-pre-line leading-relaxed">
                             {tips}
                           </div>
                         </div>
                         <div className="mt-4 pt-4 border-t border-indigo-100 flex justify-end">
                           <button 
                             onClick={handleGenerateTips}
                             className="text-xs font-medium text-indigo-600 hover:text-indigo-800 flex items-center gap-1"
                           >
                             Refresh Analysis <Sparkles size={12} />
                           </button>
                         </div>
                      </div>
                    )}
                  </div>
                )}

              </div>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
